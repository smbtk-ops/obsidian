# Чек-лист проверки Kubernetes кластера

## 1. Проверка нод
```bash
kubectl get nodes -o wide
````

Все master и worker должны быть в статусе **Ready**.
---
## 2. Проверка системных подов
```bash
kubectl get pods -A -o wide
```

Особое внимание на пространства:

- **kube-system** → CoreDNS, kube-proxy, calico (или другой CNI), etcd, контроллеры.
- **metallb-system** → speaker и controller.
- **ingress-nginx** → ingress-контроллер.
- **kube-system** → metrics-server.

Все поды должны быть в статусе **Running** или **Completed**.

---
## 3. Проверка CNI (Calico/Flannel и т.п.)
```bash
kubectl get pods -n kube-system -l k8s-app=calico-node
```

Все **calico-node** должны быть Running.
Тест сетевой связности:
```bash
kubectl run test-net --rm -it --image=busybox -- sh
# Внутри пода:
ping 10.96.0.1   # Kubernetes API (ClusterIP)
ping google.com  # Внешняя сеть (если разрешено)
```

---

## 4. Проверка DNS
```bash
kubectl run -i --tty dns-test --image=busybox:1.28 --restart=Never -- sh
# Внутри пода:
nslookup kubernetes.default
```

Должен резолвиться сервис **kubernetes.default.svc.cluster.local**.

---
## 5. Проверка MetalLB
Проверка пула IP:
```bash
kubectl -n metallb-system get ipaddresspools.metallb.io
```

Создание тестового сервиса LoadBalancer (nginx-lb.yml):
```yaml
apiVersion: v1
kind: Service
metadata:
  name: nginx-lb
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
    - port: 80
      targetPort: 80
```

`kubectl apply -f nginx-lb.yml`
`kubectl get svc nginx-lb`

Если в EXTERNAL-IP видим не прочерк а IP выделился из пула `192.168.88.196-199`, значит MetalLB работает.

---

## 6. Проверка Ingress NGINX
Деплой тестового приложения:
```bash
kubectl create deployment web --image=nginx --port=80
kubectl expose deployment web --port=80 --target-port=80
```

Создание Ingress:
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: web-ingress
spec:
  rules:
  - host: test.local
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web
            port:
              number: 80
```

В `/etc/hosts` на локальной машине добавить:

```
192.168.88.196 test.local
```

Проверить доступ в браузере.

---
## 7. Проверка Metrics Server
```bash
kubectl top nodes
kubectl top pods -A
```

Если выводятся CPU/RAM метрики, значит всё ок.

---
## 8. Проверка Helm
```bash
helm version
helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
helm search repo kubernetes-dashboard
```

Должна выводиться версия Helm и список чартов.

---
## 9. kubeconfig

Создать бэкап:
```bash
cp ~/.kube/config ~/kubeconfig-backup-$(date +%F)
```

---

## 10. Smoke-тест rolling update
```bash
kubectl create deployment web --image=nginx:1.26
kubectl set image deployment/web nginx=nginx:1.27
kubectl rollout status deployment/web
```

---

## 11. Проверка VIP IP

Если используется **kube-vip** или аналогичный механизм, проверить доступность виртуального IP:
```bash
# Проверка наличия подов с VIP
kubectl get all -A -o wide | grep kube-vip

# Проверка пинга VIP изнутри кластера
ping -c3 <VIP_IP>

# Проверка доступности API через VIP
kubectl cluster-info --kubeconfig ~/.kube/config

curl -k https://<VIP_IP>:6443/healthz
ответ должен быть "ok"
```

VIP должен отвечать на ping и использоваться в качестве `server:` в kubeconfig.
