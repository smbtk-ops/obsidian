
## ETCD ‚Äî –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Ç–µ—Ä–∞

|–ù–æ–¥–∞|IP|–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞|Peer URL|
|---|---|---|---|
|master1|192.168.88.191|master1|[https://192.168.88.191:2380](https://192.168.88.191:2380/)|
|master2|192.168.88.192|master2|[https://192.168.88.192:2380](https://192.168.88.192:2380/)|
|master3|192.168.88.193|master3|[https://192.168.88.193:2380](https://192.168.88.193:2380/)|

---

## 1. –ß—Ç–æ –±—ç–∫–∞–ø–∏—Ç—å –Ω–∞ –∫–∞–∂–¥–æ–π ETCD-–Ω–æ–¥–µ

**–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:**

```bash
/etc/etcd.env
/etc/systemd/system/etcd.service
/etc/ssl/etcd/ssl/
```

---

## 2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö ETCD

–ù–∞ –ª—é–±–æ–π –∂–∏–≤–æ–π master-–Ω–æ–¥–µ (–æ–±—ã—á–Ω–æ `master1`):

```bash
export ETCDCTL_API=3
export $(grep -v '^#' /etc/etcd.env | xargs -d '\n')

etcdctl snapshot save /var/backups/etcd/snapshots/etcd-$(date +%F_%H-%M).db
```

---

## 3. –ê—Ä—Ö–∏–≤–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥–æ–≤ –∏ —Å–Ω–∞–ø—à–æ—Ç–∞

```bash
mkdir -p /var/backups/etcd/snapshots
tar czf /var/backups/etcd/etcd-backup-$(date +%F).tar.gz \
  /etc/etcd.env \
  /etc/systemd/system/etcd.service \
  /etc/ssl/etcd/ssl \
  /var/backups/etcd/snapshots
```

>–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å `/var/backups/etcd/` –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ S3.

---

## 4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥—ë–Ω–Ω–æ–π –Ω–æ–¥—ã ETCD

### 4.1 –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å –∏ –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ

```bash
systemctl stop etcd
mv /var/lib/etcd /var/lib/etcd.broken.$(date +%s)
```

---

### 4.2 –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π peer –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞ (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å –∂–∏–≤–æ–π –Ω–æ–¥—ã)

```bash
export ETCDCTL_API=3
export $(grep -v '^#' /etc/etcd.env | xargs -d '\n')

etcdctl member list
# –ø—Ä–∏–º–µ—Ä –≤—ã–≤–æ–¥–∞:
# cb20fd8d405d00c6, started, master2, https://192.168.88.192:2380, ...

etcdctl member remove cb20fd8d405d00c6
```

---

### 4.3 –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–¥—É –∑–∞–Ω–æ–≤–æ –≤ –∫–ª–∞—Å—Ç–µ—Ä

```bash
etcdctl member add master2 --peer-urls=https://192.168.88.192:2380
```

---

### 4.4 –í `/etc/etcd.env` –Ω–∞ –Ω–æ–≤–æ–π –Ω–æ–¥–µ:

- —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `ETCD_INITIAL_CLUSTER_STATE="existing"`
- —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `ETCD_INITIAL_CLUSTER` —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∞–∫—Ç—É–∞–ª—å–Ω–æ–π —Ç–æ–ø–æ–ª–æ–≥–∏–µ–π:  ```
  ETCD_INITIAL_CLUSTER="master1=https://192.168.88.191:2380,master2=https://192.168.88.192:2380,master3=https://192.168.88.193:2380"```


---

## 5. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å–Ω–∞–ø—à–æ—Ç–∞

> –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–Ω–∞ –≤—Å–µ—Ö –Ω–æ–¥–∞—Ö** (–ø—Ä–∏ –ø–æ–ª–Ω–æ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞).

### master1:

```bash
export ETCDCTL_API=3
etcdctl snapshot restore /var/backups/etcd/snapshots/etcd-2025-10-06_10-00.db \
  --data-dir=/var/lib/etcd \
  --name=master1 \
  --initial-advertise-peer-urls=https://192.168.88.191:2380 \
  --initial-cluster=master1=https://192.168.88.191:2380,master2=https://192.168.88.192:2380,master3=https://192.168.88.193:2380
chown -R etcd:etcd /var/lib/etcd
```

### master2:

```bash
export ETCDCTL_API=3
etcdctl snapshot restore /var/backups/etcd/snapshots/etcd-2025-10-06_10-00.db \
  --data-dir=/var/lib/etcd \
  --name=master2 \
  --initial-advertise-peer-urls=https://192.168.88.192:2380 \
  --initial-cluster=master1=https://192.168.88.191:2380,master2=https://192.168.88.192:2380,master3=https://192.168.88.193:2380
chown -R etcd:etcd /var/lib/etcd
```

### master3:

```bash
export ETCDCTL_API=3
etcdctl snapshot restore /var/backups/etcd/snapshots/etcd-2025-10-06_10-00.db \
  --data-dir=/var/lib/etcd \
  --name=master3 \
  --initial-advertise-peer-urls=https://192.168.88.193:2380 \
  --initial-cluster=master1=https://192.168.88.191:2380,master2=https://192.168.88.192:2380,master3=https://192.168.88.193:2380
chown -R etcd:etcd /var/lib/etcd
```

---

## 6. –ó–∞–ø—É—Å–∫ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

–ù–∞ –∫–∞–∂–¥–æ–π –Ω–æ–¥–µ:

```bash
systemctl daemon-reload
systemctl start etcd
systemctl enable etcd
```

---

## 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞

```bash
export ETCDCTL_API=3
export $(grep -v '^#' /etc/etcd.env | xargs -d '\n')

etcdctl endpoint status --write-out=table
```

–ü—Ä–∏–º–µ—Ä –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞:
```
+---------------------------+------------------+---------+---------+-----------+-----------+-----------+------------+
|         ENDPOINT          |        ID        | VERSION | DB SIZE | IS LEADER | RAFT TERM | RAFT INDEX| DB HASH    |
+---------------------------+------------------+---------+---------+-----------+-----------+-----------+------------+
| https://127.0.0.1:2379    | 1efcd356c9613bd5 | 3.5.14  |  55 MB  | true      |   42      |  657342   | 1234567890 |
+---------------------------+------------------+---------+---------+-----------+-----------+-----------+------------+
```

---
## 8. –ë—ã—Å—Ç—Ä–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π –Ω–æ–¥—ã (–ø—Ä–∏–º–µ—Ä master2)

```bash
systemctl stop etcd
mv /var/lib/etcd /var/lib/etcd.old.$(date +%s)
export ETCDCTL_API=3
export $(grep -v '^#' /etc/etcd.env | xargs -d '\n')
etcdctl member remove <OLD_ID>
etcdctl member add master2 --peer-urls=https://192.168.88.192:2380
vi /etc/etcd.env     # –∏—Å–ø—Ä–∞–≤–∏—Ç—å ETCD_INITIAL_CLUSTER_STATE="existing"
systemctl daemon-reload
systemctl start etcd
```

---

## 9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö —É–∑–ª–æ–≤:

```bash
etcdctl endpoint health --cluster
etcdctl member list
```

–í—Å–µ —É–∑–ª—ã –¥–æ–ª–∂–Ω—ã –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ **started**.

---


# Kubernetes Backup & Restore ‚Äî `/etc/kubernetes`

## –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–ö–∞—Ç–∞–ª–æ–≥ `/etc/kubernetes` —Å–æ–¥–µ—Ä–∂–∏—Ç:

- –≤—Å–µ kubeconfig-—Ñ–∞–π–ª—ã (`admin.conf`, `kubelet.conf`, `controller-manager.conf`, `scheduler.conf`);
- —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã CA, apiserver, front-proxy, service-account;
- —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã control-plane (`/etc/kubernetes/manifests/`);
- kubeadm-–∫–æ–Ω—Ñ–∏–≥ (`kubeadm-config.yaml`).

–≠—Ç–æ ‚Äî **—Å–µ—Ä–¥—Ü–µ –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes**.  
–ï–≥–æ –±—ç–∫–∞–ø –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è control-plane –¥–∞–∂–µ –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –ø–æ—Ç–µ—Ä–µ –Ω–æ–¥—ã.

---

## 1. –ë—ç–∫–∞–ø –∫–∞—Ç–∞–ª–æ–≥–∞ `/etc/kubernetes`

### üîπ 1.1. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±—ç–∫–∞–ø-–Ω–∞–±–æ—Ä

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∫–æ–ø–∏—Ä—É–µ–º:
```bash
/etc/kubernetes/
/etc/systemd/system/kubelet.service
```

---

### üîπ 1.2. –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ –º–∞—Å—Ç–µ—Ä-–Ω–æ–¥–µ
```bash
mkdir -p /var/backups/k8s
tar czf /var/backups/k8s/etc-kubernetes-$(hostname)-$(date +%F).tar.gz \
  /etc/kubernetes \
  /etc/systemd/system/kubelet.service
```

---

### üîπ 1.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞—Ä—Ö–∏–≤–∞
```bash
tar -tf /var/backups/k8s/etc-kubernetes-$(hostname)-$(date +%F).tar.gz | head
```

---

### üîπ 1.4. –ü–µ—Ä–µ–¥–∞—á–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
```bash
scp /var/backups/k8s/etc-kubernetes-$(hostname)-$(date +%F).tar.gz \
    backup@192.168.88.250:/backups/k8s/
```

---

## 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ **—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –Ω–æ–¥–µ**

–≠—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî –∫–æ–≥–¥–∞ –Ω–æ–¥–∞ –∂–∏–≤–∞, –Ω–æ –∫–æ–Ω—Ñ–∏–≥–∏ –∏–ª–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, kubelet.conf –∏–ª–∏ pki).

### üîπ 2.1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å kubelet
```bash
systemctl stop kubelet
```

---

### üîπ 2.2. –†–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å –∞—Ä—Ö–∏–≤
```bash
tar xzf /backups/k8s/etc-kubernetes-master1-2025-10-06.tar.gz -C /
```

---

### üîπ 2.3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –∏ –≤–ª–∞–¥–µ–ª—å—Ü–µ–≤
```bash
chown -R root:root /etc/kubernetes
chmod 600 /etc/kubernetes/*.conf
chmod 700 /etc/kubernetes/pki
```

---

### üîπ 2.4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω—Ñ–∏–≥–æ–≤
```bash
ls /etc/kubernetes
# admin.conf  controller-manager.conf  kubelet.conf  scheduler.conf  pki/  manifests/
```

---

### üîπ 2.5. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å kubelet
```bash
systemctl daemon-reload
systemctl restart kubelet
systemctl enable kubelet
```

---

### üîπ 2.6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
```bash
journalctl -u kubelet -f
kubectl --kubeconfig /etc/kubernetes/admin.conf get nodes -o wide
```

–ï—Å–ª–∏ kubelet –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑-–∑–∞ –Ω–µ–≤–µ—Ä–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤:

```bash
kubeadm init phase kubeconfig kubelet --config=/etc/kubernetes/kubeadm-config.yaml
systemctl restart kubelet
```

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–æ–¥–∞ —Å–Ω–æ–≤–∞ —Å—Ç–∞–Ω–µ—Ç —Ä–∞–±–æ—á–∏–º control-plane-—É–∑–ª–æ–º, –≤—Å–µ static-pods (apiserver, controller, scheduler) –∑–∞–ø—É—Å—Ç—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.

---

## 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ **—á–∏—Å—Ç–æ–º (–Ω–æ–≤–æ–º) —Å–µ—Ä–≤–µ—Ä–µ**

–≠—Ç–æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π ‚Äî –∫–æ–≥–¥–∞ —Å—Ç–∞—Ä–∞—è master-–Ω–æ–¥–∞ —É—Ç–µ—Ä—è–Ω–∞, –∞ —Ç—ã —Ö–æ—á–µ—à—å —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–æ–≤—É—é –∏–∑ –±—ç–∫–∞–ø–∞ `/etc/kubernetes`.

---

### üîπ 3.1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —á–∏—Å—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —É–∫–∞–∑–∞—Ç—å –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤)
```bash
apt update && apt install -y apt-transport-https ca-certificates curl gpg
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.32/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.32/deb/ /" > /etc/apt/sources.list.d/kubernetes.list
apt update && apt install -y kubelet kubeadm kubectl containerd
systemctl enable containerd --now
```

---
### üîπ 3.2. –ö–æ–ø–∏—Ä—É–µ–º –∞—Ä—Ö–∏–≤
```bash
scp backup@192.168.88.250:/backups/k8s/etc-kubernetes-master1-2025-10-06.tar.gz /root/
tar xzf /root/etc-kubernetes-master1-2025-10-06.tar.gz -C /
```

---
### üîπ 3.3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```bash
ls /etc/kubernetes
# admin.conf  controller-manager.conf  kubelet.conf  scheduler.conf  pki/  manifests/  kubeadm-config.yaml
```

---
### üîπ 3.4. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤ kubelet
```bash
systemctl enable kubelet
systemctl start kubelet
```

---
### üîπ 3.5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞
```bash
journalctl -u kubelet -f
```

–ß–µ—Ä–µ–∑ 30‚Äì60 —Å–µ–∫—É–Ω–¥ kubelet –ø–æ–¥–Ω–∏–º–µ—Ç:

- apiserver,
- controller-manager,
- scheduler (–∏–∑ `/etc/kubernetes/manifests/`).

---
### üîπ 3.6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ API
```bash
kubectl --kubeconfig /etc/kubernetes/admin.conf get nodes -o wide
```

---
### üîπ 3.7. –ï—Å–ª–∏ IP –Ω–æ–≤–æ–π –Ω–æ–¥—ã –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –æ—Ç —Å—Ç–∞—Ä–æ–≥–æ

apiserver-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å:
```bash
mv /etc/kubernetes/pki/apiserver* /etc/kubernetes/pki/old/
kubeadm init phase certs apiserver --config=/etc/kubernetes/kubeadm-config.yaml  # –¢—É—Ç –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∞–π–ø–∏ –≤ –±–ª–æ–∫ certSANs
systemctl restart kubelet
```

---

### üîπ 3.8. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤

```bash
kubectl get componentstatuses
kubectl get pods -n kube-system -o wide
```

–û–∂–∏–¥–∞–µ–º, —á—Ç–æ control-plane-–ø–æ–¥—ã –≤ —Å—Ç–∞—Ç—É—Å–µ `Running`.

---
## 4. –ß–∞—Å—Ç–Ω—ã–µ —Å–ª—É—á–∞–∏

| –°–∏—Ç—É–∞—Ü–∏—è                   | –†–µ—à–µ–Ω–∏–µ                                                                              |
| -------------------------- | ------------------------------------------------------------------------------------ |
| kubelet.conf –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç   | `kubeadm init phase kubeconfig kubelet --config=/etc/kubernetes/kubeadm-config.yaml` |
| kube-apiserver –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç | –ø–µ—Ä–µ—Å–æ–∑–¥–∞–π apiserver.crt –∏ apiserver.key                                             |
| admin.conf –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç     | `kubeadm init phase kubeconfig admin --config=/etc/kubernetes/kubeadm-config.yaml`   |
| –¥—Ä—É–≥–æ–π hostname            | –æ–±–Ω–æ–≤–∏ SAN –≤ kubeadm-config.yaml –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–π apiserver —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç                   |

---
