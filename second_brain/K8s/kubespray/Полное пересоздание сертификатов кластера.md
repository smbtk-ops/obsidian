
Восстановление ETCD:

```
kubeadm init phase certs etcd-ca
```

Команда выше сгенерит новый CA в `/etc/kubernetes/pki/etcd/` для нашего etcd-кластера. Все остальные сертификаты должны быть им подписаны, копируем его вместе с приватным ключом на остальные мастера в папку `/etc/kubernetes/pki/etcd/`:

```
/etc/kubernetes/pki/etcd/ca.{key,crt}
```

Генерируем остальные etcd-сертификаты на всех мастерах:

```
kubeadm init phase certs etcd-healthcheck-client
kubeadm init phase certs etcd-server
```

Далее копируем все сертификаты в `/etc/ssl/etcd/ssl/` и переименовываем согласно `/etc/etcd.env`:

```
cp -R /etc/kubernetes/pki/etcd/* /etc/ssl/etcd/ssl/
mv server.crt member-master3.pem
mv server.key member-master3-key.pem
mv healthcheck-client.crt admin-master3.pem
mv healthcheck-client.key admin-master3-key.pem
mv ca.crt ca.pem
```

Меняем владельца и права на файлы:

```
chown etcd:etcd /etc/ssl/etcd/ssl/*
chmod 644 /etc/ssl/etcd/ssl/*
```

перезапускаем сервис:
`systemctl restart etcd`

и проверяем работоспособность базы:

```
ETCDCTL_API=3 etcdctl --endpoints=https://127.0.0.1:2379   --cacert=/etc/ssl/etcd/ssl/ca.pem   --cert=/etc/ssl/etcd/ssl/member-master1.pem   --key=/etc/ssl/etcd/ssl/member-master1-key.pem   member list
```

Должны увидеть что то вроде этого:

```
1efcd356c9613bd5, started, etcd1, https://192.168.88.191:2380, https://192.168.88.191:2379, false
5834fcc2a7981d7e, started, etcd3, https://192.168.88.192:2380, https://192.168.88.192:2379, false
a3e02f006176c4a8, started, etcd2, https://192.168.88.193:2380, https://192.168.88.193:2379, false
```






---


crictl rm -f `crictl ps -aq`


/etc/kubernetes/kubeadm-config.yaml

apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: v1.32.8
controlPlaneEndpoint: "192.168.88.190:6443"   # <-- kube-vip как точка входа
apiServer:
  certSANs:
  - kubernetes
  - kubernetes.default
  - kubernetes.default.svc
  - kubernetes.default.svc.cluster.local
  - 10.233.0.1
  - localhost
  - 127.0.0.1
  - ::1
  - master1
  - master2
  - master3
  - 192.168.88.190
  - 192.168.88.191
  - 192.168.88.192
  - 192.168.88.193
  - 192.168.88.190         # <-- kube-vip
  - master2.cluster.local
  - master3.cluster.local




```
kubeadm init phase certs all --config /etc/kubernetes/kubeadm-config.yaml

openssl x509 -in /etc/kubernetes/pki/apiserver.crt -noout -text | grep -A1 "Subject Alternative Name"

rm -rf /etc/kubernetes/*.conf
kubeadm init phase kubeconfig all --config /etc/kubernetes/kubeadm-config.yaml
cp -f /etc/kubernetes/admin.conf ~/.kube/config



systemctl restart kubelet
```


```
480  systemctl stop kubelet
  481  rm -f /var/lib/kubelet/pki/kubelet-client*       /var/lib/kubelet/pki/kubelet.crt       /var/lib/kubelet/pki/kubelet.key       /etc/kubernetes/kubelet.conf
  482  kubeadm init phase kubeconfig kubelet --config=/etc/kubernetes/kubeadm-config.yaml
  483  rm -f /var/lib/kubelet/kubeadm-flags.env
  484  systemctl daemon-reload
  485  systemctl start kubelet
  486  kubectl get csr
  487  kubectl get nodes -o wide

```