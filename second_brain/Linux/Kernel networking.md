

```conf
############################################
# ОБЩИЕ СЕТЕВЫЕ НАСТРОЙКИ
############################################

net.core.netdev_max_backlog = 32768      # Максимальная очередь пакетов, ожидающих обработки ядром. Чем выше — тем меньше риск потери пакетов при 10G+ сетях.
net.core.somaxconn = 32768               # Максимальное число ожидающих соединений в listen(). Увеличиваем для высоконагруженных веб/DB серверов.
net.core.rmem_max = 16777216             # Максимальный размер буфера приема (read buffer).
net.core.wmem_max = 16777216             # Максимальный размер буфера отправки (write buffer).
net.core.rmem_default = 16777216         # Буфер приёма по умолчанию.
net.core.wmem_default = 16777216         # Буфер отправки по умолчанию.
net.core.optmem_max = 40960              # Максимальный объем вспомогательной памяти для одного сокета.

net.ipv4.ip_local_port_range = 1024 65535 # Диапазон портов для исходящих подключений. Расширяем, чтобы избежать исчерпания ephemeral портов.

############################################
# TCP НАСТРОЙКИ
############################################

net.ipv4.tcp_fastopen = 3                # TCP Fast Open. Разрешает обмен данными уже на стадии SYN. 3 = и клиент, и сервер.
net.ipv4.tcp_fin_timeout = 5             # Таймаут ожидания FIN. Быстро освобождает сокеты. (По умолчанию 60).
net.ipv4.tcp_max_syn_backlog = 16384     # Максимальная очередь входящих SYN (неподтверждённых соединений).
net.ipv4.tcp_max_tw_buckets = 2000000    # Кол-во соединений в TIME_WAIT, после превышения старые очищаются.
net.ipv4.tcp_slow_start_after_idle = 0   # Не использовать медленный старт после простоя — быстрее для long-lived соединений.
net.ipv4.tcp_tw_reuse = 1                # Разрешить повторное использование TIME_WAIT для исходящих соединений.

# Буферы TCP
net.ipv4.tcp_rmem = 4096 8388608 16777216 # Мин / по умолчанию / макс для буфера приёма TCP.
net.ipv4.tcp_wmem = 4096 4194394 16777216 # Мин / по умолчанию / макс для буфера отправки TCP.

############################################
# ЗАЩИТА И ICMP
############################################

net.ipv4.conf.default.rp_filter = 1      # Включить фильтрацию spoofed IP (reverse path filter).
net.ipv4.conf.default.accept_source_route = 0 # Запретить source routing пакеты (защита).
icmp_echo_ignore_broadcasts = 1          # Не отвечать на ICMP broadcast (защита от DoS).
net.ipv4.icmp_echo_ignore_all = 0        # 1 = отключить все ответы на ping. Обычно оставляем 0.

############################################
# TCP KEEPALIVE
############################################

net.ipv4.tcp_keepalive_time = 60         # Время простоя перед первой keepalive-проверкой (по умолч. 7200 сек).
net.ipv4.tcp_keepalive_intvl = 10        # Интервал между keepalive-запросами.
net.ipv4.tcp_keepalive_probes = 6        # Количество keepalive-проверок до разрыва соединения.

############################################
# ДОПОЛНИТЕЛЬНЫЕ TCP-ПАРАМЕТРЫ
############################################

net.ipv4.tcp_syn_retries = 1             # Количество повторных попыток SYN перед ошибкой (по умолч. 6).
net.ipv4.tcp_synack_retries = 1          # Кол-во повторов SYN+ACK (по умолч. 5).
net.ipv4.tcp_syncookies = 0              # SYN cookies. 1 = защита от SYN flood. 0 = быстрее, если нет атак.
net.ipv4.tcp_max_orphans = 32768         # Макс. число "осиротевших" соединений (без владельца-процесса).
net.ipv4.tcp_orphan_retries = 0          # Количество попыток повторной передачи перед закрытием "осиротевших" соединений.
net.ipv4.tcp_mtu_probing = 1             # Автоподбор MTU, если есть проблемы с фрагментацией.
net.ipv4.tcp_adv_win_scale = 1           # Доля буфера под recv window. 1 = оптимум для 10G.
net.ipv4.tcp_moderate_rcvbuf = 1         # Автоматическая настройка tcp_rmem под нагрузку.

############################################
# DOCKER / CONNTRACK
############################################

net.netfilter.nf_conntrack_max = 1048576       # Макс. кол-во отслеживаемых соединений conntrack.
net.netfilter.nf_conntrack_buckets = 262144    # Размер хэш-таблицы conntrack (~1/4 от max).
# Проверка: sysctl net.netfilter.nf_conntrack_count

############################################
# LIMITS И INOTIFY
############################################

fs.inotify.max_user_instances = 8192     # Макс. число inotify-инстансов на пользователя.
fs.inotify.max_user_watches = 524288     # Макс. число файлов/директорий для мониторинга inotify.

############################################
# СИСТЕМНЫЕ НАСТРОЙКИ
############################################

kernel.sched_autogroup_enabled = 0       # Отключить автогруппировку процессов по TTY (лучше масштабируемость серверов).
kernel.sysrq = 0                         # Запретить SysRq (повышение безопасности).
kernel.msgmnb = 65536                    # Максимум байтов в очереди сообщений.
kernel.msgmax = 65536                    # Максимальный размер одного сообщения.
kernel.shmmax = 68719476736              # Максимальный сегмент shared memory (важно для PostgreSQL).
kernel.shmall = 4294967296               # Общее количество страниц SHM.

vm.swappiness = 0                        # Не использовать swap (на серверах с достаточной RAM).
vm.dirty_background_ratio = 5            # % грязных страниц памяти, при котором фоновые записи запускаются.
vm.dirty_ratio = 15                      # % грязных страниц, при котором процессы блокируются.

############################################
# KEEPALIVE ДЛЯ MySQL / PostgreSQL
############################################
# (важно для предотвращения долгих зависших соединений)

net.ipv4.tcp_keepalive_time = 180        # 3 минуты
net.ipv4.tcp_keepalive_probes = 5        # 5 попыток
net.ipv4.tcp_keepalive_intvl = 30        # Интервал 30 сек

############################################
# SOCKET LIMITS (ulimit)
############################################

# Файл /etc/security/limits.conf
* soft nofile 262140                      # Лимит открытых файлов (soft).
* hard nofile 262140                      # Лимит открытых файлов (hard).
root soft nofile 262140
root hard nofile 262140
* soft core unlimited                     # Неограниченный размер core dump.
* hard core unlimited
root soft core unlimited
root hard core unlimited
```

---


---

# Таблица рекомендуемых sysctl-настроек

| Категория                       | Параметр                             | Web-сервер                            | DB-сервер                                 | Docker-хост/k8s                              |
| ------------------------------- | ------------------------------------ | ------------------------------------- | ----------------------------------------- | -------------------------------------------- |
| **Сокеты и очереди**            | `net.core.somaxconn`                 | 65535 (очень много соединений)        | 16384 (баланс)                            | 32768 (среднее значение)                     |
|                                 | `net.core.netdev_max_backlog`        | 32768 (10G сетка)                     | 16384 (умеренно)                          | 65535 (массовый NAT)                         |
| **TCP-поведение**               | `net.ipv4.tcp_fin_timeout`           | 5 (быстро освобождать сокеты)         | 15 (бережно к долгим коннектам)           | 5                                            |
|                                 | `net.ipv4.tcp_max_syn_backlog`       | 32768 (массовые подключения)          | 8192                                      | 16384                                        |
|                                 | `net.ipv4.tcp_tw_reuse`              | 1 (повторное использование TIME_WAIT) | 0 (лучше не рисковать для БД)             | 1                                            |
|                                 | `net.ipv4.tcp_slow_start_after_idle` | 0 (ускорить повторные коннекты)       | 1 (безопаснее для транзакций)             | 0                                            |
| **TCP буферы**                  | `net.ipv4.tcp_rmem`                  | `4096 87380 16777216`                 | `8192 262144 4194304`                     | `4096 8388608 16777216`                      |
|                                 | `net.ipv4.tcp_wmem`                  | `4096 65536 16777216`                 | `8192 262144 4194304`                     | `4096 4194394 16777216`                      |
| **Conntrack (NAT/Docker)**      | `net.netfilter.nf_conntrack_max`     | 262144                                | 262144                                    | 1048576 (обязательно, иначе падения при NAT) |
|                                 | `net.netfilter.nf_conntrack_buckets` | 65536                                 | 65536                                     | 262144                                       |
| **ICMP/защита**                 | `icmp_echo_ignore_broadcasts`        | 1                                     | 1                                         | 1                                            |
|                                 | `net.ipv4.icmp_echo_ignore_all`      | 0 (ping нужен для мониторинга)        | 0                                         | 0                                            |
| **Keepalive**                   | `net.ipv4.tcp_keepalive_time`        | 60 (быстро обрывать мёртвые коннекты) | 1800 (длинные коннекты БД)                | 300                                          |
|                                 | `net.ipv4.tcp_keepalive_intvl`       | 10                                    | 30                                        | 15                                           |
|                                 | `net.ipv4.tcp_keepalive_probes`      | 6                                     | 9                                         | 5                                            |
| **Память / кеши**               | `vm.swappiness`                      | 0 (без swap)                          | 1 (БД любит RAM, swap крайне нежелателен) | 0                                            |
|                                 | `vm.dirty_background_ratio`          | 10                                    | 5 (снижает лаги записи)                   | 10                                           |
|                                 | `vm.dirty_ratio`                     | 20                                    | 15                                        | 20                                           |
| **Inotify (мониторинг файлов)** | `fs.inotify.max_user_instances`      | 1024                                  | 1024                                      | 8192 (Docker/K8s сильно грузят inotify)      |
|                                 | `fs.inotify.max_user_watches`        | 65536                                 | 131072                                    | 524288                                       |

---


- **Web-серверы** → требуют агрессивного уменьшения таймаутов (`tcp_fin_timeout=5`), больших очередей (`somaxconn=65535`), буферов под 10G.
- **DB-серверы** → упор на **стабильность**, не злоупотреблять `tcp_tw_reuse`, оставить больше времени на FIN, снизить `dirty_background_ratio`.
- **Docker-хосты/K8s** → критичен `nf_conntrack_max` (иначе будет `nf_conntrack: table full, dropping packet`), а также лимиты inotify.
    